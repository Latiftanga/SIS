<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Django Auth{% endblock %}</title>

    <!-- DaisyUI & Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10" xintegrity="sha384-D1Kt99CQMDuVetoNH8QcbSdxxFIGbtiE85WdhLdcUtnrEXhdG3BTkFaLMgwwENBw" crossorigin="anonymous"></script>
    
    <style>
        /* HTMX Indicator Styles */
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .htmx-request.htmx-indicator {
            display: inline-block;
        }
    </style>

    <!-- Theme Controller JS (Load) - From new auth page -->
    <script>
        // Auto detect system theme preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
        }
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!('theme' in localStorage)) {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });
    </script>
</head>
<body class="min-h-screen bg-base-200" hx-boost="true">
    
    <!-- Header -->
    {% include 'partials/_header.html' %}

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-8">
        <!-- Optional: Django Messages -->
        {% include 'partials/_messages.html' %}
        
        {% block content %}
        <!-- Page content goes here -->
        {% endblock %}
    </main>

    <!-- Footer -->
    {% include 'partials/_footer.html' %}

    <!-- Theme Persistence JS -->
    <script>
        // --- Get CSRF Token from cookie ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // --- Configure HTMX to send CSRF token ---
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = csrftoken;
        });

        // --- Theme Toggle JS (Copied from new auth page) ---
        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            // Check if the icons exist before toggling
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            if (lightIcon && darkIcon) {
                lightIcon.classList.toggle('hidden', !isDark);
                darkIcon.classList.toggle('hidden', isDark);
            }
        }
        
        function toggleTheme() {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.theme = newTheme;
            updateThemeIcon();
        }
        
        // --- Initialize Theme ---
        // We need to wait for the DOM to be loaded to find the icons
        document.addEventListener('DOMContentLoaded', function() {
            updateThemeIcon();

            // Find the header theme controller and add the click event
            const headerController = document.querySelector('.header-theme-controller');
            if(headerController) {
                headerController.addEventListener('click', toggleTheme);
            }
        });

        // --- HTMX Loading States JS (Copied from new auth page) ---
        document.body.addEventListener('htmx:beforeRequest', e => {
            const form = e.detail.elt;
            if (form && form.tagName === 'FORM') {
                const btn = form.querySelector('button[type="submit"]');
                if (btn) {
                    // Only handle disabled state
                    btn.disabled = true;
                }
            }
        });
        
        document.body.addEventListener('htmx:afterRequest', e => {
            const form = e.detail.elt;
            if (form && form.tagName === 'FORM') {
                const btn = form.querySelector('button[type="submit"]');
                if (btn) {
                    btn.disabled = false;
                }
            }
            const target = e.detail.target;
            if (target) {
                const newBtn = target.querySelector('button[type="submit"]');
                if (newBtn) {
                    newBtn.disabled = false;
                }
            }
        });
    </script>
</body>
</html>